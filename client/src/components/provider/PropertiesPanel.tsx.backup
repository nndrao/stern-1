/**
 * Properties Panel Component
 * Displays and edits properties of selected menu items
 * PERFORMANCE OPTIMIZED: Uses React Hook Form with onBlur mode to update parent only when user tabs out
 */

import React, { useCallback, useMemo, useEffect } from 'react';
import { useForm, Controller } from 'react-hook-form';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Switch } from '@/components/ui/switch';
import { Separator } from '@/components/ui/separator';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { buildUrl } from '@/openfin/utils';
import { RefreshCw, Image } from 'lucide-react';
import { logger } from '@/utils/logger';

import { DockMenuItem, DEFAULT_WINDOW_OPTIONS, DEFAULT_VIEW_OPTIONS } from '@stern/openfin-platform';

interface PropertiesPanelProps {
  item: DockMenuItem;
  onUpdate: (updates: Partial<DockMenuItem>) => void;
  onIconSelect: (callback: (icon: string) => void) => void;
}

export const PropertiesPanel: React.FC<PropertiesPanelProps> = ({
  item,
  onUpdate,
  onIconSelect
}) => {
  logger.debug('[FORM_INPUT] PropertiesPanel render', { itemId: item.id, caption: item.caption }, 'PropertiesPanel');

  // React Hook Form with onBlur mode - updates parent ONLY when user tabs out
  const { register, control, watch, setValue, reset, getValues } = useForm<DockMenuItem>({
    mode: 'onBlur', // Only validate and trigger updates on blur/tab out
    defaultValues: item,
  });

  // Reset form ONLY when item ID changes (selecting different node)
  // DO NOT reset when item props change due to our own updates
  useEffect(() => {
    logger.info('[FORM_INPUT] Item ID changed, resetting form', { itemId: item.id, caption: item.caption }, 'PropertiesPanel');
    reset(item);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [item.id]); // Only reset when ID changes, not when other props change

  // Callback for handling blur events on text inputs
  const handleTextInputBlur = useCallback((fieldName: string) => {
    const values = getValues();
    logger.info('[FORM_INPUT] Text input blur', {
      fieldName,
      value: values[fieldName as keyof DockMenuItem],
      allValues: values
    }, 'PropertiesPanel');
    onUpdate(values);
  }, [getValues, onUpdate]);

  // Generate unique ID
  const generateId = useCallback(() => {
    const id = `menu-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    logger.info('[FORM_INPUT] Generate ID clicked', { id }, 'PropertiesPanel');
    setValue('id', id, { shouldValidate: true, shouldDirty: true });
    onUpdate({ id });
  }, [setValue, onUpdate]);

  // Handle window option changes (immediate update for switches/selects)
  const handleWindowOptionChange = useCallback((key: string, value: any) => {
    logger.info('[FORM_INPUT] Window option change', { key, value }, 'PropertiesPanel');
    const currentWindowOptions = watch('windowOptions') || {};
    const updated = {
      windowOptions: {
        ...currentWindowOptions,
        [key]: value
      }
    };
    setValue('windowOptions', updated.windowOptions, { shouldValidate: true });
    onUpdate(updated);
  }, [watch, setValue, onUpdate]);

  // Handle view option changes (immediate update for switches/selects)
  const handleViewOptionChange = useCallback((key: string, value: any) => {
    logger.info('[FORM_INPUT] View option change', { key, value }, 'PropertiesPanel');
    const currentViewOptions = watch('viewOptions') || {};
    const updated = {
      viewOptions: {
        ...currentViewOptions,
        [key]: value
      }
    };
    setValue('viewOptions', updated.viewOptions, { shouldValidate: true });
    onUpdate(updated);
  }, [watch, setValue, onUpdate]);

  // Memoize full URL construction
  const fullUrl = useMemo(() =>
    item.url ? buildUrl(item.url) : '',
    [item.url]
  );

  return (
    <Card className="h-full">
      <CardHeader>
        <CardTitle>Item Properties</CardTitle>
        <CardDescription>
          Configure the selected menu item
        </CardDescription>
      </CardHeader>
      <CardContent>
        <Tabs defaultValue="general" className="w-full">
          <TabsList className="grid w-full grid-cols-3">
            <TabsTrigger value="general">General</TabsTrigger>
            <TabsTrigger value="window" disabled={item.openMode !== 'window'}>
              Window
            </TabsTrigger>
            <TabsTrigger value="view" disabled={item.openMode !== 'view'}>
              View
            </TabsTrigger>
          </TabsList>

          <TabsContent value="general" className="space-y-4">
            {/* Caption */}
            <div className="space-y-2">
              <Label htmlFor="caption">Caption *</Label>
              <Input
                id="caption"
                {...register('caption', {
                  required: true,
                  onChange: (e) => {
                    logger.debug('[FORM_INPUT] Caption onChange', { value: e.target.value }, 'PropertiesPanel');
                  },
                  onBlur: () => {
                    logger.info('[FORM_INPUT] Caption onBlur triggered', {}, 'PropertiesPanel');
                    handleTextInputBlur('caption');
                  }
                })}
                placeholder="Menu item text"
              />
            </div>

            {/* ID */}
            <div className="space-y-2">
              <Label htmlFor="id">Unique ID *</Label>
              <div className="flex gap-2">
                <Input
                  id="id"
                  {...register('id', {
                    required: true,
                    onChange: (e) => {
                      logger.debug('[FORM_INPUT] ID onChange', { value: e.target.value }, 'PropertiesPanel');
                    },
                    onBlur: () => handleTextInputBlur('id')
                  })}
                  placeholder="Unique identifier"
                />
                <Button
                  variant="outline"
                  size="icon"
                  onClick={generateId}
                  title="Generate ID"
                >
                  <RefreshCw className="h-4 w-4" />
                </Button>
              </div>
            </div>

            {/* URL */}
            <div className="space-y-2">
              <Label htmlFor="url">Component URL</Label>
              <Input
                id="url"
                {...register('url', {
                  onChange: (e) => {
                    logger.debug('[FORM_INPUT] URL onChange', { value: e.target.value }, 'PropertiesPanel');
                  },
                  onBlur: () => handleTextInputBlur('url')
                })}
                placeholder="/data-grid, /watchlist, etc."
                disabled={item.children && item.children.length > 0}
              />
              {fullUrl && (
                <p className="text-xs text-muted-foreground">
                  Full URL: {fullUrl}?id={item.id}
                </p>
              )}
            </div>

            {/* Open Mode */}
            <div className="space-y-2">
              <Label htmlFor="openMode">Open Mode</Label>
              <Controller
                name="openMode"
                control={control}
                render={({ field }) => (
                  <Select
                    value={field.value}
                    onValueChange={(value: 'window' | 'view') => {
                      field.onChange(value);
                      onUpdate({ openMode: value });
                    }}
                    disabled={item.children && item.children.length > 0}
                  >
                    <SelectTrigger id="openMode">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="window">New Window</SelectItem>
                      <SelectItem value="view">New View (Tab)</SelectItem>
                    </SelectContent>
                  </Select>
                )}
              />
            </div>

            {/* Icon */}
            <div className="space-y-2">
              <Label htmlFor="icon">Icon</Label>
              <div className="flex gap-2">
                <Input
                  id="icon"
                  {...register('icon', {
                    onChange: (e) => {
                      logger.debug('[FORM_INPUT] Icon onChange', { value: e.target.value }, 'PropertiesPanel');
                    },
                    onBlur: () => handleTextInputBlur('icon')
                  })}
                  placeholder="/icons/app.svg"
                />
                <Button
                  variant="outline"
                  size="icon"
                  onClick={() => {
                    logger.info('[FORM_INPUT] Icon picker button clicked', {}, 'PropertiesPanel');
                    onIconSelect((icon) => {
                      logger.info('[FORM_INPUT] Icon selected from picker', { icon }, 'PropertiesPanel');
                      setValue('icon', icon, { shouldValidate: true });
                      onUpdate({ icon });
                    });
                  }}
                  title="Select Icon"
                >
                  <Image className="h-4 w-4" />
                </Button>
              </div>
            </div>

            {/* Order */}
            <div className="space-y-2">
              <Label htmlFor="order">Sort Order</Label>
              <Input
                id="order"
                type="number"
                {...register('order', {
                  valueAsNumber: true,
                  min: 0,
                  onChange: (e) => {
                    logger.debug('[FORM_INPUT] Order onChange', { value: e.target.value }, 'PropertiesPanel');
                  },
                  onBlur: () => handleTextInputBlur('order')
                })}
                min="0"
              />
            </div>
          </TabsContent>

          <TabsContent value="window" className="space-y-4">
            <div className="space-y-4">
              {/* Window Dimensions */}
              <div>
                <h4 className="text-sm font-medium mb-3">Dimensions</h4>
                <div className="grid grid-cols-2 gap-3">
                  <div className="space-y-2">
                    <Label htmlFor="width">Width</Label>
                    <Controller
                      name="windowOptions.width"
                      control={control}
                      render={({ field }) => (
                        <Input
                          id="width"
                          type="number"
                          value={field.value || DEFAULT_WINDOW_OPTIONS.width}
                          onChange={(e) => {
                            const value = parseInt(e.target.value);
                            field.onChange(value);
                            handleWindowOptionChange('width', value);
                          }}
                          min="100"
                        />
                      )}
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="height">Height</Label>
                    <Controller
                      name="windowOptions.height"
                      control={control}
                      render={({ field }) => (
                        <Input
                          id="height"
                          type="number"
                          value={field.value || DEFAULT_WINDOW_OPTIONS.height}
                          onChange={(e) => {
                            const value = parseInt(e.target.value);
                            field.onChange(value);
                            handleWindowOptionChange('height', value);
                          }}
                          min="100"
                        />
                      )}
                    />
                  </div>
                </div>
              </div>

              <Separator />

              {/* Window Constraints */}
              <div>
                <h4 className="text-sm font-medium mb-3">Size Constraints</h4>
                <div className="grid grid-cols-2 gap-3">
                  <div className="space-y-2">
                    <Label htmlFor="minWidth">Min Width</Label>
                    <Controller
                      name="windowOptions.minWidth"
                      control={control}
                      render={({ field }) => (
                        <Input
                          id="minWidth"
                          type="number"
                          value={field.value || DEFAULT_WINDOW_OPTIONS.minWidth}
                          onChange={(e) => {
                            const value = parseInt(e.target.value);
                            field.onChange(value);
                            handleWindowOptionChange('minWidth', value);
                          }}
                          min="0"
                        />
                      )}
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="minHeight">Min Height</Label>
                    <Controller
                      name="windowOptions.minHeight"
                      control={control}
                      render={({ field }) => (
                        <Input
                          id="minHeight"
                          type="number"
                          value={field.value || DEFAULT_WINDOW_OPTIONS.minHeight}
                          onChange={(e) => {
                            const value = parseInt(e.target.value);
                            field.onChange(value);
                            handleWindowOptionChange('minHeight', value);
                          }}
                          min="0"
                        />
                      )}
                    />
                  </div>
                </div>
              </div>

              <Separator />

              {/* Window Options */}
              <div>
                <h4 className="text-sm font-medium mb-3">Window Options</h4>
                <div className="space-y-3">
                  <div className="flex items-center justify-between">
                    <Label htmlFor="resizable">Resizable</Label>
                    <Controller
                      name="windowOptions.resizable"
                      control={control}
                      render={({ field }) => (
                        <Switch
                          id="resizable"
                          checked={field.value ?? DEFAULT_WINDOW_OPTIONS.resizable}
                          onCheckedChange={(checked) => {
                            field.onChange(checked);
                            handleWindowOptionChange('resizable', checked);
                          }}
                        />
                      )}
                    />
                  </div>
                  <div className="flex items-center justify-between">
                    <Label htmlFor="maximizable">Maximizable</Label>
                    <Controller
                      name="windowOptions.maximizable"
                      control={control}
                      render={({ field }) => (
                        <Switch
                          id="maximizable"
                          checked={field.value ?? DEFAULT_WINDOW_OPTIONS.maximizable}
                          onCheckedChange={(checked) => {
                            field.onChange(checked);
                            handleWindowOptionChange('maximizable', checked);
                          }}
                        />
                      )}
                    />
                  </div>
                  <div className="flex items-center justify-between">
                    <Label htmlFor="minimizable">Minimizable</Label>
                    <Controller
                      name="windowOptions.minimizable"
                      control={control}
                      render={({ field }) => (
                        <Switch
                          id="minimizable"
                          checked={field.value ?? DEFAULT_WINDOW_OPTIONS.minimizable}
                          onCheckedChange={(checked) => {
                            field.onChange(checked);
                            handleWindowOptionChange('minimizable', checked);
                          }}
                        />
                      )}
                    />
                  </div>
                  <div className="flex items-center justify-between">
                    <Label htmlFor="center">Center on Screen</Label>
                    <Controller
                      name="windowOptions.center"
                      control={control}
                      render={({ field }) => (
                        <Switch
                          id="center"
                          checked={field.value ?? DEFAULT_WINDOW_OPTIONS.center}
                          onCheckedChange={(checked) => {
                            field.onChange(checked);
                            handleWindowOptionChange('center', checked);
                          }}
                        />
                      )}
                    />
                  </div>
                  <div className="flex items-center justify-between">
                    <Label htmlFor="frame">Show Frame</Label>
                    <Controller
                      name="windowOptions.frame"
                      control={control}
                      render={({ field }) => (
                        <Switch
                          id="frame"
                          checked={field.value ?? DEFAULT_WINDOW_OPTIONS.frame}
                          onCheckedChange={(checked) => {
                            field.onChange(checked);
                            handleWindowOptionChange('frame', checked);
                          }}
                        />
                      )}
                    />
                  </div>
                  <div className="flex items-center justify-between">
                    <Label htmlFor="alwaysOnTop">Always on Top</Label>
                    <Controller
                      name="windowOptions.alwaysOnTop"
                      control={control}
                      render={({ field }) => (
                        <Switch
                          id="alwaysOnTop"
                          checked={field.value ?? false}
                          onCheckedChange={(checked) => {
                            field.onChange(checked);
                            handleWindowOptionChange('alwaysOnTop', checked);
                          }}
                        />
                      )}
                    />
                  </div>
                </div>
              </div>
            </div>
          </TabsContent>

          <TabsContent value="view" className="space-y-4">
            <div className="space-y-4">
              {/* View Bounds */}
              <div>
                <h4 className="text-sm font-medium mb-3">View Bounds</h4>
                <div className="grid grid-cols-2 gap-3">
                  <div className="space-y-2">
                    <Label htmlFor="viewWidth">Width</Label>
                    <Controller
                      name="viewOptions.bounds.width"
                      control={control}
                      render={({ field }) => (
                        <Input
                          id="viewWidth"
                          type="number"
                          value={field.value || DEFAULT_VIEW_OPTIONS.bounds.width}
                          onChange={(e) => {
                            const value = parseInt(e.target.value);
                            field.onChange(value);
                            handleViewOptionChange('bounds', {
                              ...watch('viewOptions.bounds'),
                              width: value
                            });
                          }}
                          min="100"
                        />
                      )}
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="viewHeight">Height</Label>
                    <Controller
                      name="viewOptions.bounds.height"
                      control={control}
                      render={({ field }) => (
                        <Input
                          id="viewHeight"
                          type="number"
                          value={field.value || DEFAULT_VIEW_OPTIONS.bounds.height}
                          onChange={(e) => {
                            const value = parseInt(e.target.value);
                            field.onChange(value);
                            handleViewOptionChange('bounds', {
                              ...watch('viewOptions.bounds'),
                              height: value
                            });
                          }}
                          min="100"
                        />
                      )}
                    />
                  </div>
                </div>
              </div>

              <Separator />

              {/* Custom Data */}
              <div>
                <h4 className="text-sm font-medium mb-3">Custom Data (JSON)</h4>
                <Controller
                  name="viewOptions.customData"
                  control={control}
                  render={({ field }) => (
                    <textarea
                      className="w-full h-32 p-2 text-sm border rounded-md font-mono"
                      value={JSON.stringify(field.value || {}, null, 2)}
                      onChange={(e) => {
                        try {
                          const customData = JSON.parse(e.target.value);
                          field.onChange(customData);
                          handleViewOptionChange('customData', customData);
                        } catch {
                          // Invalid JSON, ignore
                        }
                      }}
                      placeholder="{}"
                    />
                  )}
                />
              </div>
            </div>
          </TabsContent>
        </Tabs>
      </CardContent>
    </Card>
  );
};